<!DOCTYPE html>
<html>

<head>
    <!-- Required meta tags-->
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <!-- Page title -->
    <title>Icon Selector</title>
    <!-- Bootstrap -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-EVSTQN3/azprG1Anm3QDgpJLIm9Nao0Yz1ztcQTwFspd3yD65VohhpuuCOmLASjC" crossorigin="anonymous">
    <!-- Vue Select -->
    <link type="text/css" rel="stylesheet" href="https://unpkg.com/vue-next-select/dist/index.min.css" />
    <style>

        .nav-tabs {
            overflow-x: auto;
            overflow-y:hidden;
            flex-wrap: nowrap;
        }

        .nav-tabs .nav-link {
            white-space: nowrap;
        }
        .icon-cell{
            transition: box-shadow 0.3s ease, background 0.3s ease, transform 0.3s ease, border-width 0.3s ease;
            /* will-change: box-shadow, background, transform; */
            transform: translateY(0px);
            border-radius: 0.3rem;
            /* background: #fff; */
            box-shadow: 0 0 0 #00000021;
            cursor: pointer;
            height: 4rem; width: 4rem;
        }

        .icon-cell:hover {
            transform: scale(1.1);
        }

        .icon-cell img {
            object-fit: contain
        }
        .icon-cell.draggable-outline {
            background: #fff;
            box-shadow: 0 2px 3px 0px #00000021;
            transform: translateY(-2px);
        }
        .icon-cell.draggable-outline:hover {
            transform: translateY(-6px);
            box-shadow: 0 9px 12px 0px #00000052;
        }
        .icon-cell.draggable-outline.sortable-ghost {
            background: transparent;
            border: 2px dotted black;
            box-shadow: none;
        }

        .icons-container {
            margin: auto;
            justify-content: space-between;
        }

        .color-options {
            position: absolute;
            top: 0;
            bottom: 0;
            height: 100%;
            display: flex;
            column-gap: 0.4rem;
            row-gap: 0.4rem;
            left: -2.25rem;
            width: calc(100% + 4.5rem);
            flex-direction: row;
            flex-wrap: wrap;
            align-content: center;
            justify-content: center;
        }

        .color-options .color-option {
            width: 1.5rem;
            height: 1.5rem;
            border-radius: 1rem;
            display: inline-block;
            border: 2px solid white;
            box-shadow: 0 1px 2px #00000078;
            transition: transform 0.25s ease, box-shadow 0.25s ease;
        }

        .color-options .color-option:hover {
            transform: translateY(-3px) scale(1.1);
            box-shadow: 0 4px 5px #00000078;
        }

        .icon-colors {
            display: flex;
            justify-content: center;
            width: 100%;
            flex-wrap: wrap; 
        }

        .icon-colors .color-option {
            display: block;
            /* flex-grow: 1; */
            flex-shrink: 0;
            height: 2rem;
            min-width: 2rem;
            cursor: pointer;
            transition: 0.2s ease box-shadow;
            will-change: box-shadow;
            box-shadow: inset 0 0 0 0 white;
        }

        @media screen and (max-width: 30rem) {
            .icon-colors .color-option {
                min-width: 4rem;
                flex-grow: 1;
            }
        }

        .icon-colors .color-option.color-selected {
            box-shadow: inset 0 0 0 3px white;
        }

        .float-enter-active,
        .float-leave-active {
        transition: transform 0.5s ease, opacity 0.5s ease;
        }

        .float-enter-from,
        .float-leave-to {
        transform: translateY(10px);
        opacity: 0;
        }

        .maskImage {
            mask-size: contain;
            mask-repeat: no-repeat;
            mask-position: center;
            -webkit-mask-size: contain;
            -webkit-mask-repeat: no-repeat;
            -webkit-mask-position: center;
            transition: background 0.5s ease;
        }
        
        .vue-dropdown {
            text-align: left;
        }

        /* Override Vue Select */
        .vue-dropdown {
            background: transparent;
        }
        .vue-dropdown-item {
            background-color: #fffc;
            box-shadow: 0px 0 0px 0px #cef1f7;
            transition: box-shadow ease 0.25s;
            z-index: 1; position: relative;
        }
        .vue-dropdown-item.highlighted {
            background-color: #ffffffcc;
            box-shadow: 0px 0 0px 2px #cef1f7;
            z-index: 2;
        }
        .vue-dropdown-item.selected {
            background-color: #eaf0f1cc;
            box-shadow: 0px 0 0px 2px #cef1f7;
            z-index: 4;
        }
        .vue-dropdown-item.highlighted.selected {
            background-color: #eaf0f1cc;
            box-shadow: 0px 0 0px 1px #cef1f7;
        }
</style>
</head>

<body>

    <div id="app">
        <!-- Recents -->
        <div v-if="openedIcons.length > 0" class="px-3">
            <p class="mb-0 fw-bold">Recent Icons</p>
            <div class="row justify-content-start px-3 icons-container flex-nowrap overflow-auto">
                <div
                    class="col-2 icon-cell"
                    v-for="icon in openedIcons"
                    :key="icon.id"
                    :title="icon.title"
                    @click="postChoice(icon,colorOptions[activeColor])">
                        <img :style="{
                            maskImage: `url('${icon.url}')`,
                            background: colorOptions[activeColor].code
                        }" class="w-100 h-100 maskImage"/>
                        <!-- <img :src="icon.url" class="w-100 h-100"/> -->
                        <!-- <transition name="float">
                        <div v-if="icon.id == currentIcon" class="color-options">
                            <div v-for="color in colorOptions" :key="color.name" :title="color.name"
                            class="color-option" :style="{background: color.code}"
                            @click="postChoice(icon,color)"></div>
                        </div>
                        </transition> -->
                </div>
            </div>
        </div>
        <div class="icons">
            <div class="filter px-3 py-2">
                <div class="row">
                    <div class="col-md text-center">
                        <div class="mb-3 row align-items-center">
                            <label for="categorySelect" class="col-sm-2 col-form-label">Category:</label>
                            <div class="col-sm-10">
                                <vue-select
                                    id="categorySelect" aria-label="Categories"
                                    style="width: 100%"
                                    :options="filteredCategories" label-by="name" value-by="id"
                                    :visible-options="filteredCategories"
                                    :searchable="true"
                                    :placeholder="categoryData[currentCategory] ? categoryData[currentCategory].name : ''"
                                    :close-on-select="true"
                                    :empty-model-value="currentCategory"
                                    search-placeholder="Type to search for a category or idea..."
                                    @search:input="categorySearch = $event.target.value"
                                    @update:model-value="setCategory($event)"> </vue-select>
                            </div>
                        </div>                        
                    </div>
                    <div class="col-md-2 text-center">
                        <div class="mb-3 row align-items-center">
                            <label for="colorSelect" class="col-6 col-form-label">Colour:</label>
                            <div class="col-4">
                                <div class="color-picker"></div>
                            </div>
                        </div>                        
                    </div>
                </div>                  
            </div>
            <div v-for="(category, index) in categoryData" :key="category.name"
            :id="`pane-${category.name}`" role="tabpanel" :aria-labelledby="`tab-${category.name}`"
            v-show="currentCategory == index">
                <div v-if="loadedTabs[index] || currentCategory == index" class="row align-content-start px-3 py-4 icons-container">
                    <div
                        class="col-2 m-2 icon-cell"
                        :class="{
                            'border border-3': icon.id == currentIcon,
                            'draggable-outline sortable-ghost': icon.title && debouncedCategorySearch.trim() && icon.title.toLowerCase().indexOf(debouncedCategorySearch.trim().toLowerCase()) >= 0
                        }"
                        v-for="icon in category.icons"
                        :key="icon.id"
                        :title="icon.title"
                        @click="postChoice(icon,colorOptions[activeColor])">
                            <!-- <img :src="`${colorIcon(icon.url)}`" class="w-100 h-100"/> -->
                            <img :style="{
                                maskImage: `url('${icon.url}')`,
                                background: colorOptions[activeColor].code
                            }" class="w-100 h-100 maskImage"/>
                            <!-- <transition name="float">
                            <div v-if="icon.id == currentIcon" class="color-options">
                                <div v-for="color in colorOptions" :key="color.name" :title="color.name"
                                class="color-option" :style="{background: color.code}"
                                @click="postChoice(icon,color)"></div>
                            </div>
                            </transition> -->
                    </div>
                    <!-- <div v-if="!editMode" class="row">
                        <div
                            class="col-2 m-1 d-flex align-items-center icon-cell"
                            :class="icon.id == currentIcon ? 'border border-3' : ''"
                            v-for="icon in category.icons"
                            :key="icon.id"
                            :title="icon.title"
                            @click="currentIcon = icon.id"
                            style="height: 4rem; width: 4rem;">
                                <img :src="icon.url" class="w-100 h-auto"/>
                        </div>
                    </div> -->
                </div>
            </div>
        </div>
        <form action="iconSelector.pyg" id="return_form" method="post" class="d-none" encType="application/x-www-form-urlencoded" ref="submitForm">
			<input type="hidden" name="returnCanvas" />
			<input type="hidden" name="returnUrl" value="%%_content_item_return_url_%%" />
			<input type="hidden" id="content_items" name="content_items" ref="content_items" />
			<input type="hidden" name="data" value="%%_data_%%">
		</form>
    </div>
    <!-- Browser support polyfills -->
    <script
        src="https://polyfill.io/v3/polyfill.min.js?features=Array.from,Promise,Symbol,Object.setPrototypeOf,Object.getOwnPropertySymbols,Set,Math.trunc"></script>
    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/js/bootstrap.bundle.min.js"
        integrity="sha384-MrcW6ZMFYlzcLA8Nl+NtUVF0sA7MsXsP1UyJoMp4YLEuNSfAP+JcXn/tWtIaxVXM"
        crossorigin="anonymous"></script>
    <!-- Load Vue (dev version) -->
    <script src="https://unpkg.com/vue@3.1.5"></script>
    <!-- SuperAgent - for fetching -->
    <script src="https://cdn.jsdelivr.net/npm/superagent"></script>
    <!-- SortableJS for Vue -->
    <!-- CDNJS :: Sortable -->
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.14.0/Sortable.min.js"></script>
    <!-- CDNJS :: Vue.Draggable (https://cdnjs.com/) -->
    <script src="https://cdn.jsdelivr.net/npm/vue-draggable-next@2.0.1/dist/vue-draggable-next.global.min.js"></script>
    <!-- UNPKG :: Vue Select -->
    <script src="https://unpkg.com/vue-next-select/dist/vue-next-select.iife.prod.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/fuse.js@6.4.6"></script>
    <!-- JSDELIVR :: Pickr -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@simonwep/pickr/dist/themes/monolith.min.css"/>
    <script src="https://cdn.jsdelivr.net/npm/@simonwep/pickr/dist/pickr.min.js"></script>

    <!-- Begin setting up Vue -->
    <script>
        const { ref, computed, watch, onMounted } = Vue;
        const IconSelector = {
            components: {
                draggable: VueDraggableNext.VueDraggableNext,
                'vue-select': VueNextSelect,
            },
            setup() {
                const recents = computed({
                    get: () => {
                        if(localStorage) {
                            let pastRecents = JSON.parse(localStorage.getItem('recents'))
                            if(pastRecents && typeof pastRecents == "object") {
                                return pastRecents
                            } else {
                                const recentsTemplate = {
                                    lastCategory: 0,
                                    openedIcons: [], // [iconData]
                                    lastColor: 1
                                }
                                localStorage.setItem('recents', JSON.stringify(recentsTemplate));
                                return recentsTemplate
                            }
                        } else {
                            console.error("Failed to load recents! Perhaps this is because it wasn't created")
                        }
                    }
                })
                let currentCategory = ref(recents.value.lastCategory);
                let openedIcons = ref(recents.value.openedIcons);
                const loadedTabs = ref([true]);
                let currentIcon = ref("");
                const categoryData = ref([]);
                let editMode = ref(false); // Don't enable drag and drop unless needed - uses a lot of energy!
                const content_items = ref(null);
                const submitForm = ref(null);
                let activeColor = ref(recents.value.lastColor);
                const colorOptions = [
                    {code: "#00467F", name: "Dark blue"},
                    {code: "#000000", name: "Black"},
                    {code: "#4A4A4C", name: "Body Grey"},
                    {code: "#8D9091", name: "Silver"},
                    {code: "#A71930", name: "Arts"},
                    {code: "#7D0063", name: "Business School"},
                    {code: "#D2492A", name: "Creative Arts and Industries"},
                    {code: "#55A51C", name: "Education and Social Work"},
                    {code: "#4F2D7F", name: "Engineering"},
                    {code: "#005B82", name: "Auckland Law School"},
                    {code: "#00877C", name: "Medical Health Sciences"},
                    {code: "#0039A6", name: "Science"},
                    {code: "#BA4482", name: "Auckland Bioengineering Institute"},
                    {code: "#006990", name: "Liggins Institute"}
                ];
                const setColor = (color) => {
                    const index = colorOptions.findIndex(e => e.code==color.code)
                    activeColor.value = index >= 0 ? index : 0;
                }
                const colorIcon = (iconUrl, color=colorOptions[activeColor.value]) => {
                    return `${iconUrl}?color=${color.code.replace('#','')}`
                }
                onMounted(() => {
                    const pickr = Pickr.create({
                        el: '.color-picker',
                        theme: 'monolith',
                        swatches: colorOptions.map(e=>e.code),
                        default: colorOptions[activeColor.value].code,
                        comparison: false,
                        lockOpacity: true,
                        // components: {
                        //     // preview: true,
                        //     opacity: false,
                        //     hue: true,
                        //     // interaction: { save: true }
                        // }
                    });
                    pickr.on('change',(c, _, inst) => {
                        const hex = c.toHEXA().toString()
                        const index = colorOptions.findIndex(e => e.code==hex)
                        if(index >= 0) {
                            activeColor.value = index
                            inst.applyColor()
                        }
                    })
                    console.log('Component is mounted!')
                })

                // Watch so we can update recents
                const submitRecents = ()=>{
                    if(localStorage) {
                        if(openedIcons.value.length > 5) {
                            // Truncate to prevent massive list
                            openedIcons.value = openedIcons.value.slice(0,5);
                        }
                        localStorage.setItem('recents', JSON.stringify({
                            lastCategory: currentCategory.value,
                            openedIcons: openedIcons.value, // [iconData]
                            lastColor: activeColor.value
                        }));
                        console.log("Recents updated!")
                    } else {console.log("Recents will not update - no local storage.")}
                }
                watch([activeColor, currentCategory, openedIcons], (val,_) =>{submitRecents()})
                
                const setCategory = (index) => {
                    console.log(`Setting category ${index}`)
                    currentCategory.value = index;
                    loadedTabs.value[index] = true;
                }
                
                const form = {
                    returnUrl: "",
                    data: ""
                }

                const postChoice = (icon=false, color=false) => {
                    const existingMatch = recents.value.openedIcons.findIndex(e=>e.url == icon.url);
                    if(existingMatch != -1) { recents.value.openedIcons.splice(existingMatch)}
                    recents.value.openedIcons.unshift(icon)
                    content_items.value.value=colorIcon(icon.url,color ? color : undefined);
                    submitRecents();
                    submitForm.value.submit();
                }

                // This Async function begins the process of fetching data to fill things out
                (async () => {
                    // Get the list of categories (and locations to fetch from)
                    const categories = await superagent.get('categoryList.json');
                    loadedTabs.value.push(...Array(categories.body.length-1).fill(false));
                    // From each category, grab the list of icons and add it to the categoryData object
                    for (let i = 0; i < categories.body.length; i++) {
                        const category = categories.body[i];
                        categoryData.value.push({
                            name: category.name,
                            id: i,
                            icons: []
                        })
                        superagent.get(category.url).then(res => {
                            // res.body.icons.forEach(i => i.selected = false)
                            categoryData.value[i].icons = res.body.icons;
                        })                        
                    }
                })();

                // Debounce search string as searching takes time
                let debouncedCategorySearch = ref("")
                let categoryTimeout = ref(null)
                const categorySearch = computed({
                    get() {
                        return debouncedCategorySearch.value
                    },
                    set(val) {
                        if (categoryTimeout.value) clearTimeout(categoryTimeout.value)
                        categoryTimeout.value = setTimeout(() => {
                            debouncedCategorySearch.value = val
                        }, 300)
                    }
                });
                const fuseSearch = computed(()=> {
                    return fuse = new Fuse(categoryData.value, {
                        keys: [{
                            name: 'name',
                            weight: 0.9
                        }, {
                            name: 'icons.title',
                            weight: 0.1
                        }],
                        shouldSort: true,
                    })
                })
                const filteredCategories = computed(()=> {
                    const search = debouncedCategorySearch.value;
                    return search.length
                        ? fuseSearch.value.search(search).map(({ item }) => item)
                        : categoryData.value
                }, {onTrack(e) { debugger }});
                watch(filteredCategories, (c, _) => {
                    console.log("filter changing!");
                    currentCategory.value = filteredCategories.value[0].id
                })

                return {
                    currentCategory,
                    categoryData,
                    loadedTabs,
                    setCategory,
                    currentIcon,
                    editMode,
                    colorOptions,
                    activeColor,
                    postChoice,
                    content_items,
                    submitForm,
                    recents,
                    openedIcons,
                    colorIcon,
                    fuseSearch,
                    categorySearch,
                    filteredCategories,
                    setColor,
                    debouncedCategorySearch,
                    categoryTimeout
                }
            }
        }
        Vue.createApp(IconSelector).mount('#app')
    </script>
</body>

</html>